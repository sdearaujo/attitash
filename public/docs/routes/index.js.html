<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "", thisFile = "home/anthonyb/dev/attitash//index.js", defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h2">
        <a href="#login">login</a>
      </div>
      <div class="heading h2">
        <a href="#auth">auth</a>
      </div>
      <div class="heading h2">
        <a href="#logout">logout</a>
      </div>
      <div class="heading h2">
        <a href="#register">register</a>
      </div>
      <div class="heading h2">
        <a href="#adduser">addUser</a>
      </div>
      <div class="heading h2">
        <a href="#follow">follow</a>
      </div>
      <div class="heading h2">
        <a href="#tash">tash</a>
      </div>
      <div class="heading h2">
        <a href="#discover">discover</a>
      </div>
      <div class="heading h2">
        <a href="#connect">connect</a>
      </div>
      <div class="heading h2">
        <a href="#settings">settings</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>Modules required to access the database</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/users.js&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">tashs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/tashs.js&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">following</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../lib/following.js&quot;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>who's logged on?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">var</span> <span class="nx">online</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="login">
  <h2>
    <a href="#login" class="pilcrow">&#182;</a>
    login
  </h2>
</div>


<p>Provides a user login view.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>redirect if logged in</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span><span class="p">(</span><span class="nx">user</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Grab any messages being sent to use from redirect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">authmessage</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span>   <span class="o">:</span> <span class="s1">&#39;User Login&#39;</span><span class="p">,</span>
                          <span class="nx">message</span> <span class="o">:</span> <span class="nx">authmessage</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="auth">
  <h2>
    <a href="#auth" class="pilcrow">&#182;</a>
    auth
  </h2>
</div>


<p>Performs <strong>basic</strong> user authentication.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">auth</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Pull the values from the form</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Perform the user lookup.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">users</span><span class="p">.</span><span class="nx">getUserByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting user! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>query returned nothing!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;cannot find user!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">pwd</span> <span class="o">==</span> <span class="nx">password</span><span class="p">){</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
        <span class="nx">online</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>found user but something went wrong. wrong password</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;wrong password!&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="logout">
  <h2>
    <a href="#logout" class="pilcrow">&#182;</a>
    logout
  </h2>
</div>


<p>Deletes user info &amp; session - then redirects to login.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">logout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>get the user from the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>if the user is not logged, show the message "Not logged in!" and redirect to the login page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>remove the user from the the array of online users</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">online</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">online</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">];</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>delete the user from the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">delete</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>redirect to login page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="register">
  <h2>
    <a href="#register" class="pilcrow">&#182;</a>
    register
  </h2>
</div>


<p>Route for register page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">authmessage</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>get the user from the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="p">{</span>  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Attitash - Register&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">authmessage</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="adduser">
  <h2>
    <a href="#adduser" class="pilcrow">&#182;</a>
    addUser
  </h2>
</div>


<p>Provides a route to create a new user.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">addUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>values obtained from the form</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">fname</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fname</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lname</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">lname</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
  

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>check if the values are not undefined</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span><span class="p">(</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span> <span class="o">&amp;&amp;</span> <span class="nx">fname</span> <span class="o">&amp;&amp;</span> <span class="nx">lname</span> <span class="o">&amp;&amp;</span> <span class="nx">email</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>put user in the database</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">users</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">fname</span><span class="p">,</span> <span class="nx">lname</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>could be another error, right now assume username is taken is reason insert failed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Username already exists!&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>log the user in and send them to the home screen</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">users</span><span class="p">.</span><span class="nx">getUserByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting user! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;cannot find user!&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span><span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
            <span class="nx">online</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>   
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="follow">
  <h2>
    <a href="#follow" class="pilcrow">&#182;</a>
    follow
  </h2>
</div>


<p>handler for following another user</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">follow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>grab the values from the query string</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">follower</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">follower</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">followee</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">followee</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>put new relation in the database</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">following</span><span class="p">.</span><span class="nx">addFollowByUsername</span><span class="p">(</span><span class="nx">follower</span><span class="p">,</span> <span class="nx">followee</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error following &quot;</span> <span class="o">+</span> <span class="nx">followee</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="tash">
  <h2>
    <a href="#tash" class="pilcrow">&#182;</a>
    tash
  </h2>
</div>


<p>Create a new tash.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">tash</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="kd">var</span> <span class="nx">uname</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>

    <span class="nx">tashs</span><span class="p">.</span><span class="nx">addTash</span><span class="p">(</span><span class="nx">uname</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error adding tash!&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="nx">tashs</span><span class="p">.</span><span class="nx">getLastTash</span><span class="p">(</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tash</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting last tash!&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>send json response data back to client to handle it in ajax success function</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">tash</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">home</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>get the news feed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">tashs</span><span class="p">.</span><span class="nx">getNewsFeed</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_tashs</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting tashs! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>get who to follow</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">following</span><span class="p">.</span><span class="nx">getWhoToFollowByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">who_to_follow</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting who to follow! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>get number of tashs by this user</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">tashs</span><span class="p">.</span><span class="nx">countTashsByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">numTashes</span><span class="p">){</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error counting tashs! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>get number of followers for this user</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">following</span><span class="p">.</span><span class="nx">countFollowersByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">numFollowers</span><span class="p">){</span>
                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error counting followers! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);}</span>
                  <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>get number of users this user is following</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">following</span><span class="p">.</span><span class="nx">countFollowingByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">numFollowing</span><span class="p">){</span>
                      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error counting following! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);}</span>
                      <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>finally...render it all</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="p">{</span> 
                          <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Attitash - Home&#39;</span><span class="p">,</span>
                          <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="nx">notification</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                          <span class="nx">username</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span>
                          <span class="nx">online</span> <span class="o">:</span> <span class="nx">online</span><span class="p">,</span>
                          <span class="nx">who_to_follow</span><span class="o">:</span> <span class="nx">who_to_follow</span><span class="p">,</span>
                          <span class="nx">tashs</span><span class="o">:</span> <span class="nx">_tashs</span><span class="p">,</span>
                          <span class="nx">numtashes</span><span class="o">:</span> <span class="nx">numTashes</span><span class="p">.</span><span class="nx">tash_count</span><span class="p">,</span>
                          <span class="nx">numfollowing</span><span class="o">:</span> <span class="nx">numFollowing</span><span class="p">.</span><span class="nx">following_count</span><span class="p">,</span>
                          <span class="nx">numfollowers</span><span class="o">:</span> <span class="nx">numFollowers</span><span class="p">.</span><span class="nx">follower_count</span><span class="p">,</span>
                          <span class="nx">trends</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;attitash&#39;</span><span class="p">,</span> <span class="s1">&#39;cs326&#39;</span><span class="p">,</span> <span class="s1">&#39;balsamiq&#39;</span><span class="p">,</span> <span class="s1">&#39;betterthantwitter&#39;</span><span class="p">,</span> <span class="s1">&#39;tash&#39;</span><span class="p">]</span>
                        <span class="p">});</span>
                      <span class="p">}</span>
                    <span class="p">});</span>
                  <span class="p">}</span>
                <span class="p">});</span>             
              <span class="p">}</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">me</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>get the news feed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">tashs</span><span class="p">.</span><span class="nx">getTashsByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_tashs</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting tashs! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>get who to follow</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">following</span><span class="p">.</span><span class="nx">getWhoToFollowByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">who_to_follow</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting who to follow! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>get followers of this user</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">following</span><span class="p">.</span><span class="nx">getFollowersByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">followers</span><span class="p">){</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting followers! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);}</span>
              <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>get users this user is following</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">following</span><span class="p">.</span><span class="nx">getFollowingByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">following</span><span class="p">){</span>
                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting following! &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);}</span>
                  <span class="k">else</span><span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>finally...render it all</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="p">{</span> 
                      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Attitash - Me&#39;</span><span class="p">,</span>
                      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="nx">notification</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                      <span class="nx">username</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span>
                      <span class="nx">online</span> <span class="o">:</span> <span class="nx">online</span><span class="p">,</span>
                      <span class="nx">who_to_follow</span><span class="o">:</span> <span class="nx">who_to_follow</span><span class="p">,</span>
                      <span class="nx">tashs</span><span class="o">:</span> <span class="nx">_tashs</span><span class="p">,</span>
                      <span class="nx">following</span><span class="o">:</span> <span class="nx">following</span><span class="p">,</span>
                      <span class="nx">followers</span><span class="o">:</span> <span class="nx">followers</span><span class="p">,</span>
                      <span class="nx">trends</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;attitash&#39;</span><span class="p">,</span> <span class="s1">&#39;cs326&#39;</span><span class="p">,</span> <span class="s1">&#39;balsamiq&#39;</span><span class="p">,</span> <span class="s1">&#39;betterthantwitter&#39;</span><span class="p">,</span> <span class="s1">&#39;tash&#39;</span><span class="p">]</span>
                    <span class="p">});</span>
                  <span class="p">}</span>
                <span class="p">});</span>
              <span class="p">}</span>
            <span class="p">});</span>             
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="discover">
  <h2>
    <a href="#discover" class="pilcrow">&#182;</a>
    discover
  </h2>
</div>


<p>Route for discover page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">discover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>get the user from the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>if the user is not logged, show the message "Not logged in!" and redirect to the login page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">following</span><span class="p">.</span><span class="nx">getWhoToFollowByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">who_to_follow</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting who to follow!&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;discover&#39;</span><span class="p">,</span> <span class="p">{</span> 
          <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Attitash - Discover&#39;</span><span class="p">,</span>
          <span class="nx">username</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span>
          <span class="nx">users</span> <span class="o">:</span> <span class="nx">online</span><span class="p">,</span>
          <span class="nx">tashs</span><span class="o">:</span> <span class="p">[],</span>
          <span class="nx">who_to_follow</span><span class="o">:</span> <span class="nx">who_to_follow</span><span class="p">,</span>
          <span class="nx">trends</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;attitash&#39;</span><span class="p">,</span> <span class="s1">&#39;cs326&#39;</span><span class="p">,</span> <span class="s1">&#39;balsamiq&#39;</span><span class="p">,</span> <span class="s1">&#39;betterthantwitter&#39;</span><span class="p">,</span> <span class="s1">&#39;tash&#39;</span><span class="p">]</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="connect">
  <h2>
    <a href="#connect" class="pilcrow">&#182;</a>
    connect
  </h2>
</div>


<p>Route for connect page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>get the user from the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>if the user is not logged, show the message "Not logged in!" and redirect to the login page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">following</span><span class="p">.</span><span class="nx">getWhoToFollowByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">who_to_follow</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting who to follow!&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="nx">tashs</span><span class="p">.</span><span class="nx">getTashsByFollowing</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">_tashs</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error getting tashs by following!&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span><span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="p">{</span> 
              <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Attitash - Connect&#39;</span><span class="p">,</span>
              <span class="nx">username</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">uname</span><span class="p">,</span>
              <span class="nx">users</span> <span class="o">:</span> <span class="nx">online</span><span class="p">,</span>
              <span class="nx">tashs</span><span class="o">:</span> <span class="nx">_tashs</span><span class="p">,</span>
              <span class="nx">who_to_follow</span><span class="o">:</span> <span class="nx">who_to_follow</span><span class="p">,</span>
              <span class="nx">trends</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;attitash&#39;</span><span class="p">,</span> <span class="s1">&#39;cs326&#39;</span><span class="p">,</span> <span class="s1">&#39;balsamiq&#39;</span><span class="p">,</span> <span class="s1">&#39;betterthantwitter&#39;</span><span class="p">,</span> <span class="s1">&#39;tash&#39;</span><span class="p">]</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">test</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">uname</span><span class="o">:</span> <span class="s2">&quot;AnthonyBAjax&quot;</span> <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="settings">
  <h2>
    <a href="#settings" class="pilcrow">&#182;</a>
    settings
  </h2>
</div>


<p>Route for settings page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">exports</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>get the user from the session</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>if the user is not logged, show the message "Not logged in!" and redirect to the login page</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;Not logged in!&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Attitash - Settings&#39;</span><span class="p">,</span>
      <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">fname</span><span class="p">,</span>
      <span class="nx">username</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
